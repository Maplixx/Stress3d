<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>S9 Ultimate Shadow Planet</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        #controls-container {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(20, 20, 20, 0.8); color: white;
            padding: 15px 20px; box-sizing: border-box;
            border-top: 2px solid #ff5500;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        #stats-box {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.7); padding: 8px;
            color: #00ff00; font-size: 18px; border-radius: 4px; font-weight: bold;
            border: 1px solid #00ff00;
            z-index: 10;
        }
        input[type=range] { width: 100%; margin: 15px 0; accent-color: #ff5500; }
        .info-text { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .warning { text-align: center; font-size: 12px; color: #ff5500; margin-top: 8px;}
        #loading { 
            position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); 
            color: orange; font-weight: bold; font-size: 1.2rem;
            text-align: center;
            z-index: 20;
            display: none; /* Começa invisível, aparece quando muda o slider */
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <div id="stats-box">FPS: <span id="fps-counter">...</span></div>
    <div id="loading">Recalculando Universo...</div>

    <div id="controls-container">
        <div class="info-text">
            <span>Complexidade (Nível 1-8): <b id="seg-display" style="color:#ff5500;">3</b></span>
        </div>
        <input type="range" id="stress-slider" min="1" max="8" value="3" step="1">
        <div style="text-align:center; font-size:13px; color:#ccc;">
            Triângulos: <span id="tri-count" style="color:cyan">Carregando...</span>
        </div>
         <div class="warning">⚠️ CUIDADO: Nível 8 pode fechar o navegador!</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let camera, scene, renderer, mesh, controls;
        let lastTime = performance.now();
        let frameCount = 0;
        const fpsDisplay = document.getElementById('fps-counter');
        // AQUI ESTAVA O ERRO: removi o espaço no nome da variável
        const loadingText = document.getElementById('loading'); 
        const mainLight = new THREE.DirectionalLight(0xffffff, 3);

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2.0;

            scene.add(new THREE.AmbientLight(0x222222));

            mainLight.position.set(5, 5, 5);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 2048; 
            mainLight.shadow.mapSize.height = 2048;
            mainLight.shadow.camera.near = 0.5;
            mainLight.shadow.camera.far = 20;
            scene.add(mainLight);
            
            const planeGeo = new THREE.PlaneGeometry(20, 20);
            const planeMat = new THREE.ShadowMaterial({ opacity: 0.3 });
            const plane = new THREE.Mesh(planeGeo, planeMat);
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = -2.5;
            plane.receiveShadow = true;
            scene.add(plane);

            createPlanet(3);

            window.addEventListener('resize', onWindowResize);
            
            const slider = document.getElementById('stress-slider');
            slider.addEventListener('change', (e) => {
                const val = parseInt(e.target.value);
                document.getElementById('seg-display').innerText = val;
                
                loadingText.style.display = 'block';
                
                // Pequeno delay para a UI atualizar antes de travar
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        createPlanet(val);
                        loadingText.style.display = 'none';
                    }, 50);
                });
            });
            
            animate();
        }

        function createPlanet(detailLevel) {
            if(mesh) {
                scene.remove(mesh);
                mesh.geometry.dispose();
                mesh.material.dispose();
            }

            // AQUI É ONDE O FILHO CHORA E A MÃE NÃO VÊ
            // detailLevel define quantas vezes subdividir cada triângulo
            const geometry = new THREE.IcosahedronGeometry(2, detailLevel);
            
            const positions = geometry.attributes.position;
            const vector = new THREE.Vector3();
            
            // Deforma a esfera para virar um asteroide/planeta complexo
             for (let i = 0; i < positions.count; i++) {
                vector.fromBufferAttribute(positions, i);
                vector.normalize();
                
                // Ruído matemático simples para criar montanhas
                const noise = Math.sin(vector.x * 10) * Math.cos(vector.y * 10) * 0.2;
                vector.multiplyScalar(2 + noise); 
                
                positions.setXYZ(i, vector.x, vector.y, vector.z);
            }
            geometry.computeVertexNormals();

            const material = new THREE.MeshStandardMaterial({ 
                color: 0x8B4513, 
                roughness: 0.8,
                metalness: 0.2,
                flatShading: detailLevel < 6 // Fica liso (smooth) se for muito detalhado
            });

            mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);

            // Contagem real de triângulos para você monitorar o peso
            const triCount = geometry.index ? geometry.index.count / 3 : positions.count / 3;
            document.getElementById('tri-count').innerText = Math.round(triCount).toLocaleString();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // Move a luz para as sombras serem dinâmicas (PESADO)
            const time = Date.now() * 0.001;
            mainLight.position.x = Math.sin(time) * 6;
            mainLight.position.z = Math.cos(time) * 6;
            
            renderer.render(scene, camera);

            const now = performance.now();
            frameCount++;
            if (now - lastTime >= 1000) {
                fpsDisplay.innerText = frameCount;
                fpsDisplay.style.color = frameCount < 20 ? 'red' : (frameCount < 40 ? 'orange' : '#00ff00');
                frameCount = 0;
                lastTime = now;
            }
        }

        init();
    </script>
</body>
</html>
